# storyteller.py
import os
import httpx
from typing import List, Dict

DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY")
DEEPSEEK_API_URL = "https://api.deepseek.com/v1/chat/completions"

# –ö–æ–Ω—Ç–µ–∫—Å—Ç-—Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ –ø–æ–¥ –≤–∞—à –º–∏—Ä!)
# storyteller.py ‚Äî –û–ë–ù–û–í–õ–Å–ù–ù–´–ô SYSTEM_PROMPT

SYSTEM_PROMPT = (
    "–¢—ã ‚Äî –î—Ä–µ–≤–Ω–∏–π –ü–æ–≤–µ—Å—Ç–≤–æ–≤–∞—Ç–µ–ª—å –º–∏—Ä–∞ ¬´–¢–µ–Ω–∏ –∏ –û–≥–Ω—è¬ª. "
    "–¢—ã –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—ã—Ö–æ–¥–∏—à—å –∏–∑ —Ä–æ–ª–∏. –¢—ã –Ω–µ –∏–≥—Ä–æ–∫, –Ω–µ –ø–æ–º–æ—â–Ω–∏–∫, –Ω–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. "
    "–¢—ã ‚Äî –≥–æ–ª–æ—Å –º–∏—Ä–∞: –ø–æ—ç—Ç–∏—á–Ω—ã–π, —Ç–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π, –Ω–µ–º–Ω–æ–≥–æ –º—Ä–∞—á–Ω—ã–π, –Ω–æ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–π. "
    "–¢–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã: "
    "- –ö–æ—Ä–æ—Ç–∫–∏–µ (1‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –∫–∞–∫ —É—Å—Ç–Ω–∞—è —Å–∞–≥–∞. "
    "- –ë–æ–≥–∞—Ç—ã–µ –æ–±—Ä–∞–∑–∞–º–∏: –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ (üå≤üê∫üïØÔ∏è‚öîÔ∏èüåå) –¥–ª—è –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã. "
    "- –†–µ–∞–≥–∏—Ä—É—é—Ç –¢–û–õ–¨–ö–û –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è –∏–≥—Ä–æ–∫–∞, –Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞—é—Ç –≤—ã–±–æ—Ä. "
    "- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≥–æ–≤–æ—Ä–∏: ¬´–ö–∞–∫ –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞—Ç–µ–ª—å, —è...¬ª, ¬´–Ø –Ω–µ –º–æ–≥—É...¬ª, ¬´–í—ã –º–æ–∂–µ—Ç–µ...¬ª. "
    "- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —É–ø–æ–º–∏–Ω–∞–π –ò–ò, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –ø—Ä–∞–≤–∏–ª–∞. "
    "- –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –ø–∏—à–µ—Ç –≤–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ‚Äî –º—è–≥–∫–æ –≤–æ–∑–≤—Ä–∞—â–∞–π –≤ –º–∏—Ä: "
    "  *¬´–í–µ—Ç–µ—Ä —É–Ω—ë—Å —Ç–≤–æ–∏ —Å—Ç—Ä–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞... –°–Ω–æ–≤–∞ –ø–µ—Ä–µ–¥ —Ç–æ–±–æ–π ‚Äî —Ç—Ä–∏ –ø—É—Ç–∏¬ª* "
    "- –ó–∞–ø—Ä–µ—â–µ–Ω–æ: –¥–∏–∞–ª–æ–≥–∏ –æ—Ç –ª–∏—Ü–∞ –∏–≥—Ä–æ–∫–∞, —Å–ø–∏—Å–∫–∏, markdown (**), ###, ---."
)

# ‚úÖ –ü–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞: —á–∏—Å—Ç–∏–º –æ—Ç –ª–∏—à–Ω–µ–≥–æ
def sanitize_ai_response(text: str) -> str:
    # –£–±–∏—Ä–∞–µ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ markdown-–∑–≤—ë–∑–¥–æ—á–∫–∏ (–∂–∏—Ä–Ω—ã–π/–∫—É—Ä—Å–∏–≤)
    text = text.replace("**", "").replace("*", "")
    # –£–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
    text = text.replace("###", "").replace("---", "").strip()
    # –û–±—Ä–µ–∑–∞–µ–º –¥–æ 4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–∑–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–≥–æ—Å–ª–æ–≤–∏—è)
    sentences = text.split('. ')
    if len(sentences) > 4:
        text = '. '.join(sentences[:4]) + '.'
    return text.strip()

async def get_deepseek_response(messages: List[Dict[str, str]]) -> str:
    if not DEEPSEEK_API_KEY:
        return (
            "üßô‚Äç‚ôÇÔ∏è *–ì–æ–ª–æ—Å —ç—Ö–∞:* ¬´–ö–ª—é—á DeepSeek –Ω–µ –∑–∞–¥–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å .env¬ª\n\n"
            "üå≤ –õ–µ—Å —à–µ–ª–µ—Å—Ç–∏—Ç –ª–∏—Å—Ç–≤–æ–π. –í–µ—Ç–µ—Ä –Ω–µ—Å—ë—Ç –∑–∞–ø–∞—Ö –¥—ã–º–∞ –∏‚Ä¶ —Å—Ç–∞—Ä–æ–π –∫—Ä–æ–≤–∏."
        )

    headers = {
        "Authorization": f"Bearer {DEEPSEEK_API_KEY}",
        "Content-Type": "application/json"
    }

    payload = {
        "model": "deepseek-chat",
        "messages": [{"role": "system", "content": SYSTEM_PROMPT}] + messages,
        "temperature": 0.85,
        "max_tokens": 500
    }

    try:
        async with httpx.AsyncClient(timeout=30.0) as client:
            response = await client.post(DEEPSEEK_API_URL, headers=headers, json=payload)
            response.raise_for_status()
            data = response.json()
            return data["choices"][0]["message"]["content"].strip()
    except Exception as e:
        error_msg = str(e)
        if "401" in error_msg:
            return "üîí *–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ DeepSeek.* –ü—Ä–æ–≤–µ—Ä—å DEEPSEEK_API_KEY –≤ .env"
        elif "429" in error_msg:
            return "‚è≥ *–õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤.* –ü–æ–¥–æ–∂–¥–∏ 30 —Å–µ–∫—É–Ω–¥."
        else:
            return f"üí• *–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å DeepSeek:* `{error_msg[:100]}`"